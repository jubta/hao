<!DOCTYPE html>
<html{{ if site.LanguageCode }} lang="{{ site.LanguageCode }}"{{ end }}>
  {{- partial "head.html" . -}}
  <body>
    {{- partial "header.html" . -}}
        
    <div id="content">
    {{- block "main" . }}{{- end }}
    </div>
    {{- partial "footer.html" . -}}
    
    {{ if eq site.Params.cookieConsent.switch "on" }}
    <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
    {{ end }}
    
    {{ $js_twbs := slice (resources.Get "js/bootstrap/util.js") (resources.Get "js/bootstrap/collapse.js") (resources.Get "js/bootstrap/dropdown.js") (resources.Get "js/bootstrap/index.js") | resources.Concat "js/bootstrap.slim.js" }}
    {{- $js_jquery := resources.Get "js/jquery.slim.js" }}
    {{- $js_popperjs := resources.Get "js/popper.min.js" }}
    {{ $js_main := resources.Get "js/main.js" | js.Build | minify | fingerprint }}
    
    {{- $js := slice $js_jquery $js_popperjs $js_twbs | resources.Concat "/assets/js/main.js" | minify | fingerprint }}
    <script src="{{ $js.RelPermalink }}" integrity="{{ $js.Data.Integrity }}" crossorigin="anonymous"></script>
    
    {{ $mainjs := resources.Get "js/main.js" | js.Build | minify | fingerprint }}
    <script src="{{ $mainjs.RelPermalink }}" integrity="{{ $mainjs.Data.Integrity }}" crossorigin="anonymous"></script>
    
    {{- $js_custom := resources.Get "js/custom.js" | resources.ExecuteAsTemplate "/assets/js/custom.js" . | minify | fingerprint }}
    <script src="{{ $js_custom.RelPermalink }}" integrity="{{ $js_custom.Data.Integrity }}" crossorigin="anonymous"></script>
    <!-- Request Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto|Lato&display=swap" rel="stylesheet">
    
    <!-- All CDN links for fonts specified in config file -->
    {{ with site.Params.font }}
      {{ range . }}
        {{ with .cdnLink }}
          {{ . }}
        {{ end }}
      {{ end }}
    {{ end }}
    <script type="text/javascript" src="//pl26563676.profitableratecpm.com/fc/26/e2/fc26e2d613e536d7a81001a08a4972f8.js"></script>
    <script src="/count.js"></script>
    <script>
      if (location.hostname === "jiun8631.pages.dev") {
        const newURL = "https://haee.dpdns.org" + location.pathname + location.search + location.hash;
        window.location.replace(newURL);
      }
    </script>

    {{/* --- 開始：混合式加密系統的全局腳本 --- */}}
    
    {{/* 1. Turnstile 官方腳本，它會自動尋找 cf-turnstile 元素並渲染 */}}
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

    {{/* 2. 後端通訊腳本 (現在會發送 Turnstile token) */}}
    <script>
    // 只有在後端加密頁面 (secure: true) 才會執行
    if (document.getElementById('secure-content-placeholder')) {
        const form = document.getElementById('password-form');
        const placeholder = document.getElementById('secure-content-placeholder');
        const errorMessage = document.getElementById('error-message');
        
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            // 從表單中獲取 Turnstile token
            const turnstileToken = form.querySelector('[name=cf-turnstile-response]').value;

            if (!turnstileToken) {
                errorMessage.textContent = '請先完成人機驗證。';
                return;
            }

            const password = document.getElementById('password-input').value;
            const path = placeholder.getAttribute('data-path');
            errorMessage.textContent = '正在驗證...';
            
            try {
                const response = await fetch('/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // 將 token 一起發送到後端
                    body: JSON.stringify({ path, password, turnstileToken }),
                });
                
                if (response.ok) {
                    const htmlContent = await response.text();
                    placeholder.innerHTML = htmlContent;
                } else {
                    const errorData = await response.json();
                    errorMessage.textContent = errorData.error || '密碼錯誤或發生未知問題。';
                    // 重置 Turnstile 以便使用者重試
                    if (typeof turnstile !== 'undefined') turnstile.reset();
                }
            } catch (error) {
                errorMessage.textContent = '無法連接到驗證服務，請檢查網路。';
                if (typeof turnstile !== 'undefined') turnstile.reset();
            }
        });
    }
    </script>
    {{/* --- 結束：混合式加密系統的全局腳本 --- */}}

  </body>
</html>