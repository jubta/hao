{{ define "main" }}
<div class="container-fluid  text-light text-center {{- if and (ne site.Params.backgImage.post "disable") (.Params.image.src) }} py-5{{ else }} bg-clr1 pb-3 pt-4 shadow{{ end }} position-relative"
{{- if and (ne site.Params.backgImage.post "disable") (.Params.image.src) }}
 style="background: url('{{ .Params.image.src | safeURL }}') 50% 95% / cover no-repeat fixed; box-shadow: inset 2000px 0 0 0 rgba(0, 0, 0, 0.65);"
{{- end -}}
>
  <div style="height:3.5rem;"></div>
  <h2>{{ .Title }}</h2>
  <p class="description">{{ .Description }}</p>
</div>
<div class="container-fluid bg-nav p-4">
  <div class="row">
    <div class="col-md-3">
      {{ if or (ne .Params.toc false) (ne .Params.toc "false") }}
      <div class="bg-mat p-4 rounded" style="overflow-x: auto;">
        <div class="h4 mb-3">
        ç›®éŒ„ ğŸ‘‡
        </div>
        {{ .TableOfContents }}
      </div>
      {{ end }}
    </div>
    <div class="col-md-9">
      {{- $postMetaTop := false }}
      {{- $postMetaBottom := false }}
      {{- range site.Params.position.postMeta }}
        {{- if eq .content "top" }}
          {{- $postMetaTop = true }}
        {{- else if eq .content "bottom" }}
          {{- $postMetaBottom = true }}
        {{- end }}
      {{- end }}
        
      {{ if or (and site.Params.social.share (eq site.Params.position.social.share "top")) (and site.Params.position.postMeta $postMetaTop) (and (site.Params.position.postMeta.tags.content) (eq site.Params.position.postMeta.tags.content "top")) }}
      <div class="py-1">
        <div class="row">
          {{- if and site.Params.position.postMeta $postMetaTop }}
          <div class="col-md-7 small text-muted post-meta my-auto">
            
            {{- $wordCount := "" }}
            {{- $readingTime := "" }}
            {{- $author := "" }}
            {{- $lastUpdated := "" }}
            
            {{- if and site.Params.position.postMeta.wordCount.content (eq site.Params.position.postMeta.wordCount.content "top") }}
              {{- $wordCount = print (.WordCount) " words" }}
            {{- end }}
            {{- if and site.Params.position.postMeta.readingTime.content (eq site.Params.position.postMeta.readingTime.content "top") }}
              {{- $readingTime = print (lang.NumFmt 0 (div .WordCount 130)) " é–±è®€æ™‚é–“" -}}
            {{- end }}
            {{- if and site.Params.position.postMeta.author.content (eq site.Params.position.postMeta.author.content "top") }}
              {{- $author = print "By " (default site.Params.meta.author .Params.author) }}
            {{- end }}
            {{- if .Lastmod }}
              {{- if and site.Params.position.postMeta.lastUpdated.content (eq site.Params.position.postMeta.lastUpdated.content "top") }}
                {{- $lastUpdated = print "<span class=''>æœ€è¿‘æ›´æ–°: " (.Lastmod.Format "2006 | 1 / 2") }}</span>
              {{- end }}
            {{- end }}
            
            {{- $postMetaPre := slice $author $wordCount $readingTime $lastUpdated }}
            {{ $postMeta := slice }}
            {{ range $postMetaPre }}
              {{ if . }}
                {{ $postMeta = $postMeta | append . }}
              {{ end }}
            {{ end }}
            
            {{- delimit $postMeta " &#183; " -}}
          
          </div>
          {{ end }}
          
          {{ if and site.Params.social.share (ne site.Params.position.social.share "bottom") }}
          <div class="col-md-auto ml-3 my-auto">
            <div class="row">
              <div class="col-auto p-0 my-auto">
              åˆ†äº« â¥&nbsp;&nbsp;
              </div>
              <div class="col p-0">
                <span class="lead">
                  {{ if in site.Params.social.share "facebook" }}
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ .Permalink }}&quote={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Facebook" aria-label="Share on Facebook"><span class="fab fa-facebook"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "twitter" }}
                    <a href="https://twitter.com/intent/tweet?source={{ .Permalink }}&text={{ .Title }}:%0A{{ .Permalink }}" rel="noreferrer nofollow" target="_blank" title="Share on Twitter" aria-label="Share on Twitter"><span class="fab fa-twitter"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "linkedin" }}
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ .Permalink }}&title={{ .Title }}&summary={{ .Params.description }}&source={{ site.Title }}" rel="noreferrer nofollow" target="_blank" title="Share on LinkedIn" aria-label="Share on LinkedIn"><span class="fab fa-linkedin"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "telegram" }}
                    <a href="https://t.me/share/url?url={{ .Permalink }}&text={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Telegram" aria-label="Share on Telegram"><span class="fab fa-telegram"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "whatsapp" }}
                    <a href="whatsapp://send?text={{ .Permalink }}%0A%0A{{ .Title }}" data-text="{{ .Title }}" data-href="{{ .Permalink }}" rel="noreferrer nofollow" target="_blank" title="Share on Whatsapp" aria-label="Share on Whatsapp"><span class="fab fa-whatsapp"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "reddit" }}
                    <a href="https://reddit.com/submit?url={{ .Permalink }}&title={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Reddit" aria-label="Share on Reddit"><span class="fab fa-reddit"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "email" }}
                    <a href="mailto:?subject={{ .Title }}&body={{ .Params.description }}%0A%0A{{ .Permalink }}" target="_blank" title="Share via email" aria-label="Share via email"><span class="fas fa-envelope"></span></a>
                  {{ end }}
                </span>
              </div>
            </div>
          </div>
          {{ end }}
        </div>
        
        {{ if and (site.Params.position.postMeta.tags.content) (eq site.Params.position.postMeta.tags.content "top") }}
          <div class="pt-2 pb-3">
          {{- range .Params.tags -}}
            <a href="/tags/{{ . | urlize }}/"><span class="badge badge-pill bg-clr2 text-nav mr-2 py-2">#{{ . | humanize | upper }}</span></a>
          {{- end -}}
          </div>
        {{ end }}
        
      </div>
      {{ end }}
      
      {{/* --- é–‹å§‹æ›¿æ› --- */}}

{{/* æª¢æŸ¥ front matter ä¸­æ˜¯å¦æœ‰ password åƒæ•¸ */}}
{{ if .Params.password }}

        {{/* --- é€™ä¸€æ®µæ˜¯ HTML å…§å®¹ï¼Œä¿æŒä¸è®Š --- */}}
    <div id="encryption-container" class="encryption-container py-3 my-2">
        <h3>é€™ç¯‡æ–‡ç« å·²è¢«åŠ å¯†</h3>
        <p>è«‹è¼¸å…¥å¯†ç¢¼ä¾†é–±è®€ï¼š</p>
        <input type="password" id="password-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥å¯†ç¢¼" autocomplete="current-password">
        <button id="decrypt-button">è§£å¯†</button>
        <p id="error-message" class="error-message"></p>
    </div>

    {{/* æˆ‘å€‘ä¸å†éœ€è¦ä¸€å€‹ç©ºçš„ div ä¾†æ”¾åŠ å¯†å…§å®¹ï¼Œå› ç‚ºåŠ å¯†å’Œè§£å¯†éƒ½åœ¨ JS è®Šæ•¸ä¸­å®Œæˆ */}}

    {{/* å¼•å…¥ CryptoJS å‡½å¼åº« */}}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    {{/* --- é€™æ˜¯éœ€è¦æ›¿æ›çš„å…¨æ–° JavaScript é‚è¼¯ --- */}}
    <script>
        // --- 1. æº–å‚™å…§å®¹ ---
        // ç²å–åŸå§‹æ–‡ç« å…§å®¹å’Œè©•è«–å€HTMLï¼Œä¸¦å°‡å®ƒå€‘è½‰æ›ç‚ºJSONå­—ä¸²ï¼Œé€™æ˜¯æœ€ç©©å®šçš„æ–¹å¼
        const originalContent = {{ .Content | jsonify }};
        const commentsHtml = {{ partial "comments.html" . | jsonify }};
        // ç²å–å¯†ç¢¼
        const correctPassword = {{ .Params.password | jsonify }};

        // --- 2. åœ¨å®¢æˆ¶ç«¯é€²è¡ŒåŠ å¯† ---
        // å°‡åŸå§‹å…§å®¹å’Œè©•è«–åˆä½µåœ¨ä¸€èµ·å¾ŒåŠ å¯†ï¼Œé€™æ¨£è§£å¯†å‡ºä¾†çš„å°±æ˜¯å®Œæ•´çš„å…§å®¹
        const encryptedData = CryptoJS.AES.encrypt(originalContent + commentsHtml, correctPassword).toString();
        
        // --- 3. ç²å–é é¢å…ƒç´  ---
        const container = document.getElementById('encryption-container');
        const decryptButton = document.getElementById('decrypt-button');
        const passwordInput = document.getElementById('password-input');
        const errorMessage = document.getElementById('error-message');

        const decryptAndShow = () => {
            const enteredPassword = passwordInput.value;
            if (!enteredPassword) {
                errorMessage.textContent = 'å¯†ç¢¼ä¸èƒ½ç‚ºç©ºï¼';
                return;
            }

            try {
                // --- 4. é—œéµçš„è§£å¯†èˆ‡é©—è­‰ ---
                // ä½¿ç”¨ä½¿ç”¨è€…è¼¸å…¥çš„å¯†ç¢¼å˜—è©¦è§£å¯†æˆ‘å€‘åœ¨ JS ä¸­åŠ å¯†çš„æ•¸æ“š
                const decryptedBytes = CryptoJS.AES.decrypt(encryptedData, enteredPassword);
                const decryptedText = decryptedBytes.toString(CryptoJS.enc.Utf8);

                // åªè¦è§£å¯†å¾Œèƒ½å¾—åˆ°éç©ºå­—ä¸²ï¼Œå°±è¦–ç‚ºæˆåŠŸ
                if (decryptedText) {
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'py-3 my-2 post-content';
                    contentDiv.innerHTML = decryptedText;
                    
                    // æ›¿æ›æ‰å¯†ç¢¼æ¡†
                    container.parentNode.replaceChild(contentDiv, container);
                } else {
                    // è§£å¯†å¤±æ•—ï¼Œæ‹‹å‡ºéŒ¯èª¤
                    throw new Error('Decryption failed, likely wrong password.');
                }
            } catch (e) {
                // æ•ç²æ‰€æœ‰éŒ¯èª¤
                errorMessage.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚';
                passwordInput.value = '';
                passwordInput.focus();
            }
        };
        
        decryptButton.addEventListener('click', decryptAndShow);
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                decryptAndShow();
            }
        });

        // é é¢åŠ è¼‰å¾Œè‡ªå‹•èšç„¦
        document.addEventListener('DOMContentLoaded', () => {
            passwordInput.focus();
        });
    </script>

{{ end }}

{{/* --- çµæŸæ›¿æ› --- */}}
      
      {{ if or (and site.Params.social.share (eq site.Params.position.social.share "bottom")) (and site.Params.position.postMeta $postMetaBottom) (and (site.Params.position.postMeta.tags.content) (eq site.Params.position.postMeta.tags.content "bottom")) }}
        <div class="pt-4 mt-2 border-top">
          <div class="row">
            {{- if and site.Params.position.postMeta $postMetaBottom }}
            <div class="col-md-7 small text-muted post-meta my-1">
            
              {{- $wordCount := "" }}
              {{- $readingTime := "" }}
              {{- $author := "" }}
              {{- $lastUpdated := "" }}
              
              {{- if and site.Params.position.postMeta.wordCount.content (eq site.Params.position.postMeta.wordCount.content "bottom") }}
                {{- $wordCount = print (.WordCount) " words" }}
              {{- end }}
              {{- if and site.Params.position.postMeta.readingTime.content (eq site.Params.position.postMeta.readingTime.content "bottom") }}
                {{- $readingTime = print (lang.NumFmt 0 (div .WordCount 130)) " min read" -}}
              {{- end }}
              {{- if and site.Params.position.postMeta.author.content (eq site.Params.position.postMeta.author.content "bottom") }}
                {{- $author = print "By " (default site.Params.meta.author .Params.author) }}
              {{- end }}
              {{- if .Lastmod }}
                {{- if and site.Params.position.postMeta.lastUpdated.content (eq site.Params.position.postMeta.lastUpdated.content "bottom") }}
                  {{- $lastUpdated = print "<span class=''>Last updated: " (.Lastmod.Format "January 2, 2006") }}</span>
                {{- end }}
              {{- end }}
              
              {{- $postMetaPre := slice $author $wordCount $readingTime $lastUpdated }}
              {{ $postMeta := slice }}
              {{ range $postMetaPre }}
                {{ if . }}
                  {{ $postMeta = $postMeta | append . }}
                {{ end }}
              {{ end }}
              
              {{- delimit $postMeta " &#183; " -}}
            
            </div>
            {{ end }}
            
            {{ if and site.Params.social.share (eq site.Params.position.social.share "bottom") }}
            <div class="col-md-auto ml-3 my-1">
              <div class="row">
                <div class="col-auto p-0">
                Share on:&nbsp;&nbsp;
                </div>
                <div class="col p-0">
                  <span class="lead">
                    {{ if in site.Params.social.share "facebook" }}
                      <a href="https://www.facebook.com/sharer/sharer.php?u={{ .Permalink }}&quote={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Facebook" aria-label="Share on Facebook"><span class="fab fa-facebook"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "twitter" }}
                      <a href="https://twitter.com/intent/tweet?source={{ .Permalink }}&text={{ .Title }}:%0A{{ .Permalink }}" rel="noreferrer nofollow" target="_blank" title="Share on Twitter" aria-label="Share on Twitter"><span class="fab fa-twitter"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "linkedin" }}
                      <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ .Permalink }}&title={{ .Title }}&summary={{ .Params.description }}&source={{ site.Title }}" rel="noreferrer nofollow" target="_blank" title="Share on LinkedIn" aria-label="Share on LinkedIn"><span class="fab fa-linkedin"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "telegram" }}
                      <a href="https://t.me/share/url?url={{ .Permalink }}&text={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Telegram" aria-label="Share on Telegram"><span class="fab fa-telegram"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "whatsapp" }}
                      <a href="whatsapp://send?text={{ .Permalink }}%0A%0A{{ .Title }}" data-text="{{ .Title }}" data-href="{{ .Permalink }}" rel="noreferrer nofollow" target="_blank" title="Share on Whatsapp" aria-label="Share on Whatsapp"><span class="fab fa-whatsapp"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "reddit" }}
                      <a href="https://reddit.com/submit?url={{ .Permalink }}&title={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Reddit" aria-label="Share on Reddit"><span class="fab fa-reddit"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "email" }}
                      <a href="mailto:?subject={{ .Title }}&body={{ .Params.description }}%0A%0A{{ .Permalink }}" target="_blank" title="Share via email" aria-label="Share via email"><span class="fas fa-envelope"></span></a>
                    {{ end }}
                  </span>
                </div>
              </div>
            </div>
            {{ end }}
          </div>
        
          {{ if and (site.Params.position.postMeta.tags.content) (ne site.Params.position.postMeta.tags.content "top") }}
            <div class="mt-3">
              {{- range .Params.tags -}}
                <a href="/tags/{{ . | urlize }}/"><span class="badge badge-pill bg-clr2 text-nav mr-2 py-2">#{{ . | humanize | upper }}</span></a>
              {{- end -}}
            </div>
          {{ end }}
        
        </div>
      {{ end }}
    </div>
  </div>
  
  {{ if site.DisqusShortname }}
    <div class="my-5">
      {{ if eq hugo.Environment "production" -}}
        {{ template "_internal/disqus.html" . }}
      {{ else }}
        <p class="lead text-center">This is where Disqus comments would appear on production website.</p>
      {{ end }}
    </div>
  {{ end }}
  
</div>
{{ end }}
