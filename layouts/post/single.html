{{ define "main" }}
  <!-- æ ‡é¢˜åŒº & èƒŒæ™¯å›¾ -->
  <div 
    class="container-fluid text-light text-center position-relative
           {{- if and (ne site.Params.backgImage.post "disable") (.Params.image.src) }} py-5{{ else }} bg-clr1 pb-3 pt-4 shadow{{ end }}"
    {{- if and (ne site.Params.backgImage.post "disable") (.Params.image.src) }}
      style="background: url('{{ .Params.image.src | safeURL }}') 50% 95% / cover no-repeat fixed;
             box-shadow: inset 2000px 0 0 0 rgba(0, 0, 0, 0.65);"
    {{- end -}}
>
  <div style="height:3.5rem;"></div>
  <h2>{{ .Title }}</h2>
  <p class="description">{{ .Description }}</p>
</div>

<div class="container-fluid bg-nav p-4">
  <div class="row">
    <!-- ç›®å½• -->
      <div class="col-md-3">
        {{ if or (ne .Params.toc false) (ne .Params.toc "false") }}
          <div class="bg-mat p-4 rounded" style="overflow-x: auto;">
            <div class="h4 mb-3">ç›®éŒ„ ğŸ‘‡</div>
            {{ .TableOfContents }}
          </div>
        {{ end }}
      </div>
      
    <!-- å†…å®¹åŒº -->
      <div class="col-md-9">
        {{/* è®¡ç®— postMetaTop / Bottom */}}
        {{- $postMetaTop := false }}
        {{- $postMetaBottom := false }}
        {{- range site.Params.position.postMeta }}
          {{- if eq .content "top" }}     {{- $postMetaTop = true }}
          {{- else if eq .content "bottom" }} {{- $postMetaBottom = true }}
          {{- end }}
        {{- end }}
        
      {{/* --- é¡¶éƒ¨ï¼šåˆ†äº«æŒ‰é’® / PostMeta / Tags --- */}}
        {{ if or
            (and site.Params.social.share (eq site.Params.position.social.share "top"))
            $postMetaTop
            (and site.Params.position.postMeta.tags.content (eq site.Params.position.postMeta.tags.content "top"))
          }}
          <div class="py-1">
            <div class="row">
              <!-- PostMeta Top -->
              {{ if $postMetaTop }}
                <div class="col-md-7 small text-muted post-meta my-auto">
                  {{- /* é€é¡¹åˆ¤æ–­æ˜¯å¦åœ¨ top æ˜¾ç¤º */ -}}
                  {{- $items := slice }}
                  {{- if eq site.Params.position.postMeta.wordCount.content "top" -}}
                    {{- $items = $items | append (print .WordCount " words") -}}
                  {{- end }}
                  {{- if eq site.Params.position.postMeta.readingTime.content "top" -}}
                    {{- $items = $items | append (print (lang.NumFmt 0 (div .WordCount 130)) " é–±è®€æ™‚é–“") -}}
                  {{- end }}
                  {{- if eq site.Params.position.postMeta.author.content "top" -}}
                    {{- $items = $items | append (print "By " (default site.Params.meta.author .Params.author)) -}}
                  {{- end }}
                  {{- if and .Lastmod (eq site.Params.position.postMeta.lastUpdated.content "top") -}}
                    {{- $items = $items | append (print "æœ€è¿‘æ›´æ–°: " (.Lastmod.Format "2006 | 1 / 2")) -}}
                  {{- end }}
                  {{- delimit $items " &#183; " -}}
                </div>
              {{ end }}
          
          <!-- åˆ†äº«æŒ‰é’® Top -->
              {{ if and site.Params.social.share (eq site.Params.position.social.share "top") }}
                <div class="col-md-auto ml-3 my-auto">
                  <div class="row">
                    <div class="col-auto p-0 my-auto">åˆ†äº« â¥&nbsp;</div>
                    <div class="col p-0">
                      <span class="lead">
                        {{ if in site.Params.social.share "facebook" }}<a href="https://www.facebook.com/sharer/sharer.php?u={{ .Permalink }}&quote={{ .Title }}"><span class="fab fa-facebook"></span></a>&nbsp;{{ end }}
                        {{ if in site.Params.social.share "twitter"  }}<a href="https://twitter.com/intent/tweet?text={{ .Title }} {{ .Permalink }}"><span class="fab fa-twitter"></span></a>&nbsp;{{ end }}
                        {{ if in site.Params.social.share "linkedin" }}<a href="https://www.linkedin.com/shareArticle?mini=true&url={{ .Permalink }}&title={{ .Title }}"><span class="fab fa-linkedin"></span></a>&nbsp;{{ end }}
                        {{ if in site.Params.social.share "telegram" }}<a href="https://t.me/share/url?url={{ .Permalink }}&text={{ .Title }}"><span class="fab fa-telegram"></span></a>&nbsp;{{ end }}
                        {{ if in site.Params.social.share "whatsapp" }}<a href="whatsapp://send?text={{ .Title }} {{ .Permalink }}"><span class="fab fa-whatsapp"></span></a>&nbsp;{{ end }}
                        {{ if in site.Params.social.share "reddit"   }}<a href="https://reddit.com/submit?url={{ .Permalink }}&title={{ .Title }}"><span class="fab fa-reddit"></span></a>&nbsp;{{ end }}
                        {{ if in site.Params.social.share "email"    }}<a href="mailto:?subject={{ .Title }}&body={{ .Permalink }}"><span class="fas fa-envelope"></span></a>{{ end }}
                      </span>
                    </div>
                  </div>
                </div>
              {{ end }}
            </div>
        
        <!-- Tags Top -->
            {{ if eq site.Params.position.postMeta.tags.content "top" }}
              <div class="pt-2 pb-3">
                {{ range .Params.tags }}
                  <a href="/tags/{{ . | urlize }}/"><span class="badge badge-pill bg-clr2 text-nav mr-2 py-2">#{{ . | humanize | upper }}</span></a>
                {{ end }}
              </div>
            {{ end }}
          </div>
        {{ end }}
      
      {{/* ================================================================== */}}
{{/*                  éŠ€è¡Œç´šå®‰å…¨ç‰ˆ - è«‹è¤‡è£½é€™è£¡                   */}}
{{/* ================================================================== */}}

{{/* --- æ­¥é©Ÿä¸€ï¼šåªç‚ºã€Œéä»˜è²»ã€æ–‡ç« æ¸²æŸ“å…§å®¹ --- */}}
{{ if not .Params.price }}
    <div id="main-content-area" class="py-3 my-2">
        {{ .Content }}
    </div>
{{ end }}


{{/* --- æ­¥é©ŸäºŒï¼šæ ¹æ“šä¸åŒæ¢ä»¶ï¼Œé¡¯ç¤ºå°æ‡‰çš„ã€Œè§£é–ç‰†ã€ --- */}}

{{ if .Params.price }}
    {{/* ============================================================= */}}
    {{/*         åŸç”Ÿ JS å¼·åˆ¶è¼‰å…¥ç‰ˆ - é€™æ˜¯æˆ‘å€‘æœ€å¾Œçš„ç‹ç‰Œ          */}}
    {{/* ============================================================= */}}
    
    {{/* 1. HTML ä½”ä½ç¬¦ (ä¿æŒä¸è®Š) */}}
    <div id="payment-placeholder">
        <div id="payment-unlock-container" class="encryption-container py-3 my-2">
            <h3>ğŸ’ è§£é–é«˜ç´šå…§å®¹</h3>
            <p>é€™æ˜¯ä¸€ç¯‡ä»˜è²»æ–‡ç« ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•é€šé PayPal è³¼è²·å¾Œå³å¯æ°¸ä¹…é–±è®€ã€‚</p>
            <div id="paypal-button-container" style="margin-top: 20px;"></div>
        </div>
    </div>
    
    {{/* 2. é€™æ˜¯æ–°çš„ã€çµ•å°å¯é çš„è…³æœ¬è¼‰å…¥å’ŒåŸ·è¡Œæ–¹å¼ */}}
    <script>
        (function() {
            // a. å®šç¾©å¥½æ‰€æœ‰éœ€è¦çš„åƒæ•¸
            const clientId = "{{ .Site.Params.paypalClientID }}";
            const currency = "{{ .Params.currency | default "USD" }}";
            const articlePath = "{{ .RelPermalink }}";
            const price = "{{ .Params.price }}";

            // b. å‹•æ…‹å‰µå»º script æ¨™ç±¤
            const script = document.createElement('script');
            script.src = `https://www.paypal.com/sdk/js?client-id=${clientId}Â¤cy=${currency}`;
            
            // c. ç•¶è…³æœ¬æˆåŠŸè¼‰å…¥å¾Œï¼ŒåŸ·è¡Œæˆ‘å€‘çš„æŒ‰éˆ•æ¸²æŸ“é‚è¼¯
            script.onload = function() {
                try {
                    if (typeof paypal === 'undefined') {
                        alert('å¥‡æ€ªçš„éŒ¯èª¤ï¼šè…³æœ¬å·²è§¸ç™¼ onloadï¼Œä½† paypal è®Šæ•¸ä¾ç„¶ä¸å­˜åœ¨ï¼');
                        return;
                    }

                    // æ¸²æŸ“ PayPal æŒ‰éˆ•
                    paypal.Buttons({
                        createOrder: function() {
                            return fetch('/create-paypal-order', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ articlePath, price, currency })
                            }).then(res => res.json()).then(orderData => orderData.id);
                        },
                        onApprove: function(data) {
                            return fetch('/capture-paypal-order', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ orderID: data.orderID, articlePath })
                            })
                            .then(res => res.ok ? res.text() : Promise.reject('è§£é–å¤±æ•—'))
                            .then(htmlContent => {
                                document.getElementById('payment-placeholder').innerHTML = htmlContent;
                            }).catch(err => {
                                alert(err.toString() + ' è¨‚å–®è™Ÿï¼š' + data.orderID);
                            });
                        },
                        onError: function(err) {
                            alert('PayPal æŒ‰éˆ•ç™¼ç”Ÿ onError éŒ¯èª¤ï¼š' + err.toString());
                        }
                    }).render('#paypal-button-container');

                } catch (err) {
                    alert('åœ¨ script.onload ä¸­ç™¼ç”Ÿäº† try-catch éŒ¯èª¤ï¼š' + err.toString());
                }
            };

            // d. è™•ç†è…³æœ¬è¼‰å…¥å¤±æ•—çš„æƒ…æ³
            script.onerror = function() {
                alert('è‡´å‘½éŒ¯èª¤ï¼šPayPal SDK è…³æœ¬è¼‰å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç€è¦½å™¨å®‰å…¨è¨­å®šã€‚');
            };

            // e. å°‡å‰µå»ºå¥½çš„ script æ¨™ç±¤æ’å…¥åˆ°æ–‡æª”ä¸­ï¼Œè§¸ç™¼ä¸‹è¼‰
            document.head.appendChild(script);

        })();
    </script>

{{ else if .Params.secure }}
    {{/* --- é¸é …äºŒï¼šå¾Œç«¯å¯†ç¢¼é–ç‰† (æœ¬èº«æ˜¯å®‰å…¨çš„) --- */}}
    <div id="secure-content-placeholder" class="py-3 my-2" data-path="{{ .RelPermalink }}">
         {{/* å¯†ç¢¼æ¡†çš„ HTML ... */}}
    </div>
    {{/* JS åœ¨ baseof.html */}}

{{ else if .Params.password }}
    {{/* --- é¸é …ä¸‰ï¼šå‰ç«¯å¯†ç¢¼é–ç‰† (æœ‰åŒæ¨£çš„å®‰å…¨é¢¨éšªï¼) --- */}}
    <div id="encryption-container" class="py-3 my-2">
        {{/* å¯†ç¢¼æ¡†çš„ HTML ... */}}
    </div>
    <div style="display:none;">{{ .Content }}</div> {{/* è­¦å‘Šï¼šé€™è£¡çš„å…§å®¹åœ¨åŸå§‹ç¢¼ä¸­å¯è¦‹ï¼ */}}
    {{/* JS åœ¨æ­¤è™• */}}

{{ end }}

{{/* ================================================================== */}}
{{/*                       è¤‡è£½åˆ°é€™è£¡çµæŸ                       */}}
{{/* ================================================================== */}}
      
      {{/* --- åº•éƒ¨ï¼šPostMeta / Share / Tags --- */}}
        {{ if or
            (and site.Params.social.share (eq site.Params.position.social.share "bottom"))
            $postMetaBottom
            (and site.Params.position.postMeta.tags.content (eq site.Params.position.postMeta.tags.content "bottom"))
          }}
          <div class="pt-4 mt-2 border-top">
            <div class="row">
              <!-- PostMeta Bottom -->
              {{ if $postMetaBottom }}
                <div class="col-md-7 small text-muted post-meta my-1">
                  {{- /* åŒä¸Šé€»è¾‘ï¼Œåˆ¤æ–­ bottom æ˜¾ç¤ºé¡¹ */ -}}
                  {{- $items := slice }}
                  {{- if eq site.Params.position.postMeta.wordCount.content "bottom" -}}
                    {{- $items = $items | append (print .WordCount " words") -}}
                  {{- end }}
                  {{- if eq site.Params.position.postMeta.readingTime.content "bottom" -}}
                    {{- $items = $items | append (print (lang.NumFmt 0 (div .WordCount 130)) " min read") -}}
                  {{- end }}
                  {{- if eq site.Params.position.postMeta.author.content "bottom" -}}
                    {{- $items = $items | append (print "By " (default site.Params.meta.author .Params.author)) -}}
                  {{- end }}
                  {{- if and .Lastmod (eq site.Params.position.postMeta.lastUpdated.content "bottom") -}}
                    {{- $items = $items | append (print "Last updated: " (.Lastmod.Format "January 2, 2006")) -}}
                  {{- end }}
                  {{- delimit $items " &#183; " -}}
                </div>
              {{ end }}
            
            <!-- Share Bottom -->
              {{ if and site.Params.social.share (eq site.Params.position.social.share "bottom") }}
                <div class="col-md-auto ml-3 my-1">
                  <!-- åŒä¸Šåˆ†äº«æŒ‰é’®ä»£ç  -->
                </div>
              {{ end }}
            </div>
        
          <!-- Tags Bottom -->
            {{ if eq site.Params.position.postMeta.tags.content "bottom" }}
              <div class="mt-3">
                {{ range .Params.tags }}
                  <a href="/tags/{{ . | urlize }}/"><span class="badge badge-pill bg-clr2 text-nav mr-2 py-2">#{{ . | humanize | upper }}</span></a>
                {{ end }}
              </div>
            {{ end }}
          </div>
        {{ end }}
  
  <!-- Disqus è¯„è®º -->
        {{ if site.DisqusShortname }}
          <div class="my-5">
            {{ if eq hugo.Environment "production" -}}
              {{ template "_internal/disqus.html" . }}
            {{ else }}
              <p class="lead text-center">æ­¤å¤„ä¸º Disqus è¯„è®ºï¼ˆä»…ç”Ÿäº§ç¯å¢ƒæ˜¾ç¤ºï¼‰ã€‚</p>
            {{ end }}
          </div>
        {{ end }}

      </div>
    </div>
  </div>
{{ end }}
