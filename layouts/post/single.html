{{ define "main" }}
<div class="container-fluid  text-light text-center {{- if and (ne site.Params.backgImage.post "disable") (.Params.image.src) }} py-5{{ else }} bg-clr1 pb-3 pt-4 shadow{{ end }} position-relative"
{{- if and (ne site.Params.backgImage.post "disable") (.Params.image.src) }}
 style="background: url('{{ .Params.image.src | safeURL }}') 50% 95% / cover no-repeat fixed; box-shadow: inset 2000px 0 0 0 rgba(0, 0, 0, 0.65);"
{{- end -}}
>
  <div style="height:3.5rem;"></div>
  <h2>{{ .Title }}</h2>
  <p class="description">{{ .Description }}</p>
</div>
<div class="container-fluid bg-nav p-4">
  <div class="row">
    <div class="col-md-3">
      {{ if or (ne .Params.toc false) (ne .Params.toc "false") }}
      <div class="bg-mat p-4 rounded" style="overflow-x: auto;">
        <div class="h4 mb-3">
        ç›®éŒ„ ğŸ‘‡
        </div>
        {{ .TableOfContents }}
      </div>
      {{ end }}
    </div>
    <div class="col-md-9">
      {{- $postMetaTop := false }}
      {{- $postMetaBottom := false }}
      {{- range site.Params.position.postMeta }}
        {{- if eq .content "top" }}
          {{- $postMetaTop = true }}
        {{- else if eq .content "bottom" }}
          {{- $postMetaBottom = true }}
        {{- end }}
      {{- end }}
        
      {{ if or (and site.Params.social.share (eq site.Params.position.social.share "top")) (and site.Params.position.postMeta $postMetaTop) (and (site.Params.position.postMeta.tags.content) (eq site.Params.position.postMeta.tags.content "top")) }}
      <div class="py-1">
        <div class="row">
          {{- if and site.Params.position.postMeta $postMetaTop }}
          <div class="col-md-7 small text-muted post-meta my-auto">
            
            {{- $wordCount := "" }}
            {{- $readingTime := "" }}
            {{- $author := "" }}
            {{- $lastUpdated := "" }}
            
            {{- if and site.Params.position.postMeta.wordCount.content (eq site.Params.position.postMeta.wordCount.content "top") }}
              {{- $wordCount = print (.WordCount) " words" }}
            {{- end }}
            {{- if and site.Params.position.postMeta.readingTime.content (eq site.Params.position.postMeta.readingTime.content "top") }}
              {{- $readingTime = print (lang.NumFmt 0 (div .WordCount 130)) " é–±è®€æ™‚é–“" -}}
            {{- end }}
            {{- if and site.Params.position.postMeta.author.content (eq site.Params.position.postMeta.author.content "top") }}
              {{- $author = print "By " (default site.Params.meta.author .Params.author) }}
            {{- end }}
            {{- if .Lastmod }}
              {{- if and site.Params.position.postMeta.lastUpdated.content (eq site.Params.position.postMeta.lastUpdated.content "top") }}
                {{- $lastUpdated = print "<span class=''>æœ€è¿‘æ›´æ–°: " (.Lastmod.Format "2006 | 1 / 2") }}</span>
              {{- end }}
            {{- end }}
            
            {{- $postMetaPre := slice $author $wordCount $readingTime $lastUpdated }}
            {{ $postMeta := slice }}
            {{ range $postMetaPre }}
              {{ if . }}
                {{ $postMeta = $postMeta | append . }}
              {{ end }}
            {{ end }}
            
            {{- delimit $postMeta " &#183; " -}}
          
          </div>
          {{ end }}
          
          {{ if and site.Params.social.share (ne site.Params.position.social.share "bottom") }}
          <div class="col-md-auto ml-3 my-auto">
            <div class="row">
              <div class="col-auto p-0 my-auto">
              åˆ†äº« â¥&nbsp;&nbsp;
              </div>
              <div class="col p-0">
                <span class="lead">
                  {{ if in site.Params.social.share "facebook" }}
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ .Permalink }}&quote={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Facebook" aria-label="Share on Facebook"><span class="fab fa-facebook"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "twitter" }}
                    <a href="https://twitter.com/intent/tweet?source={{ .Permalink }}&text={{ .Title }}:%0A{{ .Permalink }}" rel="noreferrer nofollow" target="_blank" title="Share on Twitter" aria-label="Share on Twitter"><span class="fab fa-twitter"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "linkedin" }}
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ .Permalink }}&title={{ .Title }}&summary={{ .Params.description }}&source={{ site.Title }}" rel="noreferrer nofollow" target="_blank" title="Share on LinkedIn" aria-label="Share on LinkedIn"><span class="fab fa-linkedin"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "telegram" }}
                    <a href="https://t.me/share/url?url={{ .Permalink }}&text={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Telegram" aria-label="Share on Telegram"><span class="fab fa-telegram"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "whatsapp" }}
                    <a href="whatsapp://send?text={{ .Permalink }}%0A%0A{{ .Title }}" data-text="{{ .Title }}" data-href="{{ .Permalink }}" rel="noreferrer nofollow" target="_blank" title="Share on Whatsapp" aria-label="Share on Whatsapp"><span class="fab fa-whatsapp"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "reddit" }}
                    <a href="https://reddit.com/submit?url={{ .Permalink }}&title={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Reddit" aria-label="Share on Reddit"><span class="fab fa-reddit"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "email" }}
                    <a href="mailto:?subject={{ .Title }}&body={{ .Params.description }}%0A%0A{{ .Permalink }}" target="_blank" title="Share via email" aria-label="Share via email"><span class="fas fa-envelope"></span></a>
                  {{ end }}
                </span>
              </div>
            </div>
          </div>
          {{ end }}
        </div>
        
        {{ if and (site.Params.position.postMeta.tags.content) (eq site.Params.position.postMeta.tags.content "top") }}
          <div class="pt-2 pb-3">
          {{- range .Params.tags -}}
            <a href="/tags/{{ . | urlize }}/"><span class="badge badge-pill bg-clr2 text-nav mr-2 py-2">#{{ . | humanize | upper }}</span></a>
          {{- end -}}
          </div>
        {{ end }}
        
      </div>
      {{ end }}
      
{{/* --- é–‹å§‹ï¼šæ··åˆå¼åŠ å¯†ç³»çµ± --- */}}

{{ if .Params.secure }}
<!-- Firebase SDK (UMD v9 ç‰ˆæœ¬ï¼Œå…¼å®¹å…¨å±€è®Šæ•¸) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js"></script> <!-- å¦‚æœä½ ç”¨ analytics -->

<!-- PayPal SDK -->
<script
  src="{{ printf "https://www.paypal.com/sdk/js?client-id=%s&currency=USD&components=buttons" (getenv "HUGO_PAYPAL_CLIENT_ID") }}"
  data-sdk-integration-source="button-factory"
  async
></script>

<!-- å…§å®¹å€å¡Š -->
<div id="secure-content-placeholder" data-path="{{ .RelPermalink }}">
  <div id="login-section" style="text-align:center;margin:2rem;display:none;">
    <h3>è«‹ç™»å…¥ä»¥è³¼è²·æˆ–è§£é–å…§å®¹</h3>
    <button id="google-login-btn">Google ç™»å…¥</button>
    <div id="login-error" style="color:red;"></div>
  </div>
  <div id="paypal-button-container" style="text-align:center;margin:40px auto;display:none;"></div>
  <p id="error-message" style="color:red;text-align:center;margin-top:1rem;"></p>
</div>

<!-- Debug é¡¯ç¤ºå€ï¼ˆç¶ è‰²æ­£å¸¸ï¼Œç´…è‰²éŒ¯èª¤ï¼‰ -->
<div id="debug-log" style="font-size:14px; margin-top:20px; border:1px solid #ccc; padding:10px; background:#f9f9f9;"></div>
<div id="debug-error" style="color:red; font-size:14px; margin-top:10px; display:none;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // å‡½æ•¸ï¼šé¡¯ç¤º log åˆ°é é¢ï¼ˆç¶ è‰²æ­£å¸¸ï¼‰
  function logToPage(message, isError) {
    var logDiv = document.getElementById('debug-log');
    var errorDiv = document.getElementById('debug-error');
    if (isError) {
      errorDiv.style.display = 'block';
      errorDiv.innerHTML += '<p>' + message + '</p>';
    } else {
      logDiv.innerHTML += '<p style="color:green;">' + message + '</p>';
    }
  }

  // è¦†å¯« console.errorï¼Œè®“éŒ¯èª¤é¡¯ç¤ºåœ¨é é¢
  var originalConsoleError = console.error;
  console.error = function(message) {
    originalConsoleError.apply(console, arguments);
    logToPage(message, true);
  };

  // æ¸¬è©¦ log
  logToPage('æ­¥é©Ÿ1: é é¢è¼‰å…¥é–‹å§‹', false);

  // Firebase é…ç½®
  var firebaseConfig = {
    apiKey: "AIzaSyCggbtYRExOD9Hp1-Gdn_avpAM-3AksTG4",
    authDomain: "hugo-login-2be80.firebaseapp.com",
    projectId: "hugo-login-2be80",
    storageBucket: "hugo-login-2be80.firebasestorage.app",
    messagingSenderId: "137087794302",
    appId: "1:137087794302:web:d1a3852ba616835bc06c2f",
    measurementId: "G-XP4MMGBYFJ"
  };

  var auth, db;
  try {
    firebase.initializeApp(firebaseConfig);
    firebase.analytics(); // å¦‚æœéœ€è¦
    auth = firebase.auth();
    db = firebase.firestore();
    logToPage('æ­¥é©Ÿ2: Firebase åˆå§‹åŒ–æˆåŠŸ', false);
  } catch (e) {
    console.error('Firebase åˆå§‹åŒ–å¤±æ•—: ' + e.message);
    document.getElementById('error-message').textContent = 'âŒ Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œä½¿ç”¨å‚™æ´æ¨¡å¼';
    initPayPalFlowFallback(); // å‚™æ´
    return;
  }

  var path = window.location.pathname;
  var errorMessage = document.getElementById('error-message');
  var loginSection = document.getElementById('login-section');
  var paypalContainer = document.getElementById('paypal-button-container');
  var loginError = document.getElementById('login-error');

  logToPage('æ­¥é©Ÿ3: è®Šæ•¸åˆå§‹åŒ–å®Œæˆï¼Œç›£è½ç™»å…¥ç‹€æ…‹', false);

  // ç™»å…¥æŒ‰éˆ•
  document.getElementById('google-login-btn').onclick = function() {
    var provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(function(e) {
      loginError.textContent = 'ç™»å…¥å¤±æ•—: ' + e.message;
    });
  };

  // ç›£è½ç™»å…¥ç‹€æ…‹
  auth.onAuthStateChanged(function(user) {
    logToPage('æ­¥é©Ÿ4: ç™»å…¥ç‹€æ…‹è®Šæ›´ - ç”¨æˆ·: ' + (user ? user.uid : 'æœªç™»å…¥'), false);
    if (!user) {
      loginSection.style.display = 'block';
      paypalContainer.style.display = 'none';
      logToPage('æ­¥é©Ÿ5: æ˜¾ç¤ºç™»å…¥å€å¡Š', false);
      return;
    }
    loginSection.style.display = 'none';
    // æª¢æŸ¥ Firestore
    var purchasesRef = db.collection('purchases');
    purchasesRef.where('userId', '==', user.uid).where('path', '==', path).get()
      .then(function(querySnapshot) {
        logToPage('æ­¥é©Ÿ6: Firestore æŸ¥è©¢å®Œæˆ - å·²è³¼è²·: ' + (!querySnapshot.empty ? 'æ˜¯' : 'å¦'), false);
        if (!querySnapshot.empty) {
          unlockContent();
        } else {
          showPayPal();
        }
      })
      .catch(function(e) {
        console.error('Firestore æŸ¥è©¢å¤±æ•—: ' + e.message);
      });
  });

  // å¼·åˆ¶æª¢æŸ¥ï¼ˆå¦‚æœ 5 ç§’å¾Œæ²’åæ‡‰ï¼‰
  setTimeout(function() {
    if (loginSection.style.display === 'none' && paypalContainer.style.display === 'none') {
      logToPage('æ­¥é©Ÿ7: 5ç§’è¶…æ™‚ - å¼·åˆ¶é¡¯ç¤ºç™»å…¥æˆ– PayPal', true);
      loginSection.style.display = 'block';
    }
  }, 5000);

  // é¡¯ç¤ºPayPalæŒ‰éˆ•ï¼ˆåŠ å¼·ç­‰å¾…ï¼‰
  function showPayPal() {
    paypalContainer.style.display = 'block';
    logToPage('æ­¥é©Ÿ8: å˜—è©¦é¡¯ç¤º PayPal æŒ‰éˆ•', false);
    var attempts = 0;
    var checkPayPal = setInterval(function() {
      attempts++;
      if (window.paypal) {
        clearInterval(checkPayPal);
        logToPage('æ­¥é©Ÿ9: PayPal SDK è¼‰å…¥æˆåŠŸï¼Œæ¸²æŸ“æŒ‰éˆ•', false);
        renderPayPal();
      } else if (attempts > 20) { // æœ€å¤šè©¦ 10 ç§’
        clearInterval(checkPayPal);
        console.error('PayPal SDK è¼‰å…¥è¶…æ™‚');
      }
    }, 500); // æ¯ 0.5 ç§’æª¢æŸ¥
  }

  // PayPal æ¸²æŸ“ï¼ˆåŸé‚è¼¯ï¼Œç„¡è®Šï¼‰
  function renderPayPal() {
    paypal.Buttons({
      createOrder: function(data, actions) {
        return actions.order.create({
          application_context: { shipping_preference: 'NO_SHIPPING', user_action: 'PAY_NOW' },
          purchase_units: [{ amount: { value: '1.50', currency_code: 'USD' } }]
        });
      },
      onApprove: function(data, actions) {
        return actions.order.capture().then(function() {
          return fetch('/verify-paypal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: path, orderID: data.orderID })
          }).then(function(res) {
            if (!res.ok) {
              errorMessage.textContent = 'âŒ ä»˜æ¬¾é©—è­‰å¤±æ•—ï¼Œè«‹è¯çµ¡ç«™é•·';
              throw new Error('é©—è­‰ PayPal å¤±æ•—');
            }
            return res.json();
          }).then(function(json) {
            var user = auth.currentUser;
            return db.collection('purchases').add({
              userId: user.uid,
              path: path,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(function() {
              unlockContent();
            });
          }).catch(function(err) {
            console.error('PayPal è™•ç†éŒ¯èª¤: ' + err.message);
          });
        });
      },
      onError: function(err) {
        console.error('PayPal æŒ‰éˆ•éŒ¯èª¤: ' + err);
      }
    }).render('#paypal-button-container');
    logToPage('æ­¥é©Ÿ10: PayPal æŒ‰éˆ•æ¸²æŸ“å®Œæˆ', false);
  }

  // è§£é–å…§å®¹
  function unlockContent() {
    logToPage('æ­¥é©Ÿ11: é–‹å§‹è§£é–å…§å®¹', false);
    fetch('/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path: path, token: "firebase" })
    })
    .then(function(r) { return r.ok ? r.text() : Promise.reject(new Error('é©—è­‰å¤±æ•—')); })
    .then(function(html) {
      document.getElementById('secure-content-placeholder').innerHTML = html;
      logToPage('æ­¥é©Ÿ12: å…§å®¹è§£é–æˆåŠŸ', false);
    })
    .catch(function(err) {
      console.error('é©—è­‰éŒ¯èª¤: ' + err.message);
    });
  }

  // å‚™æ´ï¼ˆåŸé‚è¼¯ï¼‰
  function initPayPalFlowFallback() {
    logToPage('æ­¥é©Ÿ0: åˆ‡æ›å‚™æ´æ¨¡å¼', true);
    // ... (ä½ çš„åŸ initPayPalFlow å…§å®¹ï¼Œç•¥ï¼Œè¦‹ä¹‹å‰å›æ‡‰)
  }
});
</script>

{{ else if .Params.password }}
  <!-- åªæœ‰ password æ¨¡å¼ä¸‹æ‰è·‘é€™æ®µ form -->
  <div id="encryption-container" style="text-align:center;margin:2rem;">
    <h3>ğŸ”’ è«‹è¼¸å…¥å¯†ç¢¼è§£é–æ–‡ç« </h3>
    <form id="password-form">
      <input type="password" id="password-input" required>
      <button type="submit">è§£é–</button>
      <p id="pw-error" style="color:red;"></p>
    </form>
  </div>
  <div id="real-content-wrapper" style="display:none;">
    {{ .Content }}
  </div>
  <script>
    const pwForm = document.getElementById('password-form');
    pwForm.addEventListener('submit', e => {
      e.preventDefault();
      if (document.getElementById('password-input').value === "{{ .Params.password }}") {
        document.getElementById('encryption-container').style.display       = 'none';
        document.getElementById('real-content-wrapper').style.display       = 'block';
      } else {
        document.getElementById('pw-error').textContent = 'å¯†ç¢¼éŒ¯èª¤';
      }
    });
  </script>

{{ else }}
  <!-- å…¬é–‹æ–‡ç«  -->
  <div class="py-3 my-2">{{ .Content }}</div>
{{ end }}
{{/* --- çµæŸï¼šæ··åˆå¼åŠ å¯†ç³»çµ± --- */}}
      
      {{ if or (and site.Params.social.share (eq site.Params.position.social.share "bottom")) (and site.Params.position.postMeta $postMetaBottom) (and (site.Params.position.postMeta.tags.content) (eq site.Params.position.postMeta.tags.content "bottom")) }}
        <div class="pt-4 mt-2 border-top">
          <div class="row">
            {{- if and site.Params.position.postMeta $postMetaBottom }}
            <div class="col-md-7 small text-muted post-meta my-1">
            
              {{- $wordCount := "" }}
              {{- $readingTime := "" }}
              {{- $author := "" }}
              {{- $lastUpdated := "" }}
              
              {{- if and site.Params.position.postMeta.wordCount.content (eq site.Params.position.postMeta.wordCount.content "bottom") }}
                {{- $wordCount = print (.WordCount) " words" }}
              {{- end }}
              {{- if and site.Params.position.postMeta.readingTime.content (eq site.Params.position.postMeta.readingTime.content "bottom") }}
                {{- $readingTime = print (lang.NumFmt 0 (div .WordCount 130)) " min read" -}}
              {{- end }}
              {{- if and site.Params.position.postMeta.author.content (eq site.Params.position.postMeta.author.content "bottom") }}
                {{- $author = print "By " (default site.Params.meta.author .Params.author) }}
              {{- end }}
              {{- if .Lastmod }}
                {{- if and site.Params.position.postMeta.lastUpdated.content (eq site.Params.position.postMeta.lastUpdated.content "bottom") }}
                  {{- $lastUpdated = print "<span class=''>Last updated: " (.Lastmod.Format "January 2, 2006") }}</span>
                {{- end }}
              {{- end }}
              
              {{- $postMetaPre := slice $author $wordCount $readingTime $lastUpdated }}
              {{ $postMeta := slice }}
              {{ range $postMetaPre }}
                {{ if . }}
                  {{ $postMeta = $postMeta | append . }}
                {{ end }}
              {{ end }}
              
              {{- delimit $postMeta " &#183; " -}}
            
            </div>
            {{ end }}
            
            {{ if and site.Params.social.share (eq site.Params.position.social.share "bottom") }}
            <div class="col-md-auto ml-3 my-1">
              <div class="row">
                <div class="col-auto p-0">
                Share on:&nbsp;&nbsp;
                </div>
                <div class="col p-0">
                  <span class="lead">
                    {{ if in site.Params.social.share "facebook" }}
                      <a href="https://www.facebook.com/sharer/sharer.php?u={{ .Permalink }}&quote={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Facebook" aria-label="Share on Facebook"><span class="fab fa-facebook"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "twitter" }}
                      <a href="https://twitter.com/intent/tweet?source={{ .Permalink }}&text={{ .Title }}:%0A{{ .Permalink }}" rel="noreferrer nofollow" target="_blank" title="Share on Twitter" aria-label="Share on Twitter"><span class="fab fa-twitter"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "linkedin" }}
                      <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ .Permalink }}&title={{ .Title }}&summary={{ .Params.description }}&source={{ site.Title }}" rel="noreferrer nofollow" target="_blank" title="Share on LinkedIn" aria-label="Share on LinkedIn"><span class="fab fa-linkedin"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "telegram" }}
                      <a href="https://t.me/share/url?url={{ .Permalink }}&text={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Telegram" aria-label="Share on Telegram"><span class="fab fa-telegram"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "whatsapp" }}
                      <a href="whatsapp://send?text={{ .Permalink }}%0A%0A{{ .Title }}" data-text="{{ .Title }}" data-href="{{ .Permalink }}" rel="noreferrer nofollow" target="_blank" title="Share on Whatsapp" aria-label="Share on Whatsapp"><span class="fab fa-whatsapp"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "reddit" }}
                      <a href="https://reddit.com/submit?url={{ .Permalink }}&title={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Reddit" aria-label="Share on Reddit"><span class="fab fa-reddit"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "email" }}
                      <a href="mailto:?subject={{ .Title }}&body={{ .Params.description }}%0A%0A{{ .Permalink }}" target="_blank" title="Share via email" aria-label="Share via email"><span class="fas fa-envelope"></span></a>
                    {{ end }}
                  </span>
                </div>
              </div>
            </div>
            {{ end }}
          </div>
        
          {{ if and (site.Params.position.postMeta.tags.content) (ne site.Params.position.postMeta.tags.content "top") }}
            <div class="mt-3">
              {{- range .Params.tags -}}
                <a href="/tags/{{ . | urlize }}/"><span class="badge badge-pill bg-clr2 text-nav mr-2 py-2">#{{ . | humanize | upper }}</span></a>
              {{- end -}}
            </div>
          {{ end }}
        
        </div>
      {{ end }}
    </div>
  </div>
  
  {{ partial "comments.html" . }}
  
</div>
{{ end }}