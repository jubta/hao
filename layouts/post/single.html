{{ define "main" }}
<div class="container-fluid  text-light text-center {{- if and (ne site.Params.backgImage.post "disable") (.Params.image.src) }} py-5{{ else }} bg-clr1 pb-3 pt-4 shadow{{ end }} position-relative"
{{- if and (ne site.Params.backgImage.post "disable") (.Params.image.src) }}
 style="background: url('{{ .Params.image.src | safeURL }}') 50% 95% / cover no-repeat fixed; box-shadow: inset 2000px 0 0 0 rgba(0, 0, 0, 0.65);"
{{- end -}}
>
  <div style="height:3.5rem;"></div>
  <h2>{{ .Title }}</h2>
  <p class="description">{{ .Description }}</p>
</div>
<div class="container-fluid bg-nav p-4">
  <div class="row">
    <div class="col-md-3">
      {{ if or (ne .Params.toc false) (ne .Params.toc "false") }}
      <div class="bg-mat p-4 rounded" style="overflow-x: auto;">
        <div class="h4 mb-3">
        ç›®éŒ„ ğŸ‘‡
        </div>
        {{ .TableOfContents }}
      </div>
      {{ end }}
    </div>
    <div class="col-md-9">
      {{- $postMetaTop := false }}
      {{- $postMetaBottom := false }}
      {{- range site.Params.position.postMeta }}
        {{- if eq .content "top" }}
          {{- $postMetaTop = true }}
        {{- else if eq .content "bottom" }}
          {{- $postMetaBottom = true }}
        {{- end }}
      {{- end }}
        
      {{ if or (and site.Params.social.share (eq site.Params.position.social.share "top")) (and site.Params.position.postMeta $postMetaTop) (and (site.Params.position.postMeta.tags.content) (eq site.Params.position.postMeta.tags.content "top")) }}
      <div class="py-1">
        <div class="row">
          {{- if and site.Params.position.postMeta $postMetaTop }}
          <div class="col-md-7 small text-muted post-meta my-auto">
            
            {{- $wordCount := "" }}
            {{- $readingTime := "" }}
            {{- $author := "" }}
            {{- $lastUpdated := "" }}
            
            {{- if and site.Params.position.postMeta.wordCount.content (eq site.Params.position.postMeta.wordCount.content "top") }}
              {{- $wordCount = print (.WordCount) " words" }}
            {{- end }}
            {{- if and site.Params.position.postMeta.readingTime.content (eq site.Params.position.postMeta.readingTime.content "top") }}
              {{- $readingTime = print (lang.NumFmt 0 (div .WordCount 130)) " é–±è®€æ™‚é–“" -}}
            {{- end }}
            {{- if and site.Params.position.postMeta.author.content (eq site.Params.position.postMeta.author.content "top") }}
              {{- $author = print "By " (default site.Params.meta.author .Params.author) }}
            {{- end }}
            {{- if .Lastmod }}
              {{- if and site.Params.position.postMeta.lastUpdated.content (eq site.Params.position.postMeta.lastUpdated.content "top") }}
                {{- $lastUpdated = print "<span class=''>æœ€è¿‘æ›´æ–°: " (.Lastmod.Format "2006 | 1 / 2") }}</span>
              {{- end }}
            {{- end }}
            
            {{- $postMetaPre := slice $author $wordCount $readingTime $lastUpdated }}
            {{ $postMeta := slice }}
            {{ range $postMetaPre }}
              {{ if . }}
                {{ $postMeta = $postMeta | append . }}
              {{ end }}
            {{ end }}
            
            {{- delimit $postMeta " &#183; " -}}
          
          </div>
          {{ end }}
          
          {{ if and site.Params.social.share (ne site.Params.position.social.share "bottom") }}
          <div class="col-md-auto ml-3 my-auto">
            <div class="row">
              <div class="col-auto p-0 my-auto">
              åˆ†äº« â¥&nbsp;&nbsp;
              </div>
              <div class="col p-0">
                <span class="lead">
                  {{ if in site.Params.social.share "facebook" }}
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ .Permalink }}&quote={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Facebook" aria-label="Share on Facebook"><span class="fab fa-facebook"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "twitter" }}
                    <a href="https://twitter.com/intent/tweet?source={{ .Permalink }}&text={{ .Title }}:%0A{{ .Permalink }}" rel="noreferrer nofollow" target="_blank" title="Share on Twitter" aria-label="Share on Twitter"><span class="fab fa-twitter"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "linkedin" }}
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ .Permalink }}&title={{ .Title }}&summary={{ .Params.description }}&source={{ site.Title }}" rel="noreferrer nofollow" target="_blank" title="Share on LinkedIn" aria-label="Share on LinkedIn"><span class="fab fa-linkedin"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "telegram" }}
                    <a href="https://t.me/share/url?url={{ .Permalink }}&text={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Telegram" aria-label="Share on Telegram"><span class="fab fa-telegram"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "whatsapp" }}
                    <a href="whatsapp://send?text={{ .Permalink }}%0A%0A{{ .Title }}" data-text="{{ .Title }}" data-href="{{ .Permalink }}" rel="noreferrer nofollow" target="_blank" title="Share on Whatsapp" aria-label="Share on Whatsapp"><span class="fab fa-whatsapp"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "reddit" }}
                    <a href="https://reddit.com/submit?url={{ .Permalink }}&title={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Reddit" aria-label="Share on Reddit"><span class="fab fa-reddit"></span></a>&nbsp;&nbsp;
                  {{ end }}
                  {{ if in site.Params.social.share "email" }}
                    <a href="mailto:?subject={{ .Title }}&body={{ .Params.description }}%0A%0A{{ .Permalink }}" target="_blank" title="Share via email" aria-label="Share via email"><span class="fas fa-envelope"></span></a>
                  {{ end }}
                </span>
              </div>
            </div>
          </div>
          {{ end }}
        </div>
        
        {{ if and (site.Params.position.postMeta.tags.content) (eq site.Params.position.postMeta.tags.content "top") }}
          <div class="pt-2 pb-3">
          {{- range .Params.tags -}}
            <a href="/tags/{{ . | urlize }}/"><span class="badge badge-pill bg-clr2 text-nav mr-2 py-2">#{{ . | humanize | upper }}</span></a>
          {{- end -}}
          </div>
        {{ end }}
        
      </div>
      {{ end }}
      
      {{/* ================================================================== */}}
{{/*                  éŠ€è¡Œç´šå®‰å…¨ç‰ˆ - è«‹è¤‡è£½é€™è£¡                   */}}
{{/* ================================================================== */}}

{{/* --- æ­¥é©Ÿä¸€ï¼šåªç‚ºã€Œéä»˜è²»ã€æ–‡ç« æ¸²æŸ“å…§å®¹ --- */}}
{{ if not .Params.price }}
    <div id="main-content-area" class="py-3 my-2">
        {{ .Content }}
    </div>
{{ end }}


{{/* --- æ­¥é©ŸäºŒï¼šæ ¹æ“šä¸åŒæ¢ä»¶ï¼Œé¡¯ç¤ºå°æ‡‰çš„ã€Œè§£é–ç‰†ã€ --- */}}

{{ if .Params.price }}
    {{/* ============================================================= */}}
    {{/*    å¸¶æœ‰å®Œæ•´å¾Œå»šç›£è¦–å™¨çš„æœ€çµ‚ç‰ˆæœ¬ - è«‹å¾é€™è£¡é–‹å§‹è¤‡è£½    */}}
    {{/* ============================================================= */}}
    
    {{/* 1. HTML ä½”ä½ç¬¦å’Œæ•¸æ“šå‚³é (ä¿æŒä¸è®Š) */}}
    <div id="payment-gateway" 
         data-client-id="{{ .Site.Params.paypalClientID }}"
         data-currency="{{ .Params.currency | default "USD" }}"
         data-article-path="{{ .RelPermalink }}"
         data-price="{{ .Params.price }}">
        
        <div id="payment-unlock-container" class="encryption-container py-3 my-2">
            <h3>ğŸ’ è§£é–é«˜ç´šå…§å®¹</h3>
            <p>é€™æ˜¯ä¸€ç¯‡ä»˜è²»æ–‡ç« ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•é€šé PayPal è³¼è²·å¾Œå³å¯æ°¸ä¹…é–±è®€ã€‚</p>
            <div id="paypal-button-container" style="margin-top: 20px;"></div>
        </div>
    </div>
    
    {{/* 2. é€™æ˜¯æœ€çµ‚çš„ JavaScriptï¼Œå¸¶æœ‰å®Œæ•´çš„éŒ¯èª¤æ•ç²å’Œé¡¯ç¤º */}}
    <script>
        (function() {
            // a. å¾ HTML çš„ data-* å±¬æ€§ä¸­å®‰å…¨åœ°è®€å–æ•¸æ“š
            const gateway = document.getElementById('payment-gateway');
            const clientId = gateway.dataset.clientId;
            const currency = gateway.dataset.currency;
            const articlePath = gateway.dataset.articlePath;
            const price = gateway.dataset.price;

            // b. å‹•æ…‹å‰µå»º script æ¨™ç±¤
            const script = document.createElement('script');
            script.src = `/get-paypal-sdk?client-id=${clientId}`;
            
            // c. ç•¶è…³æœ¬æˆåŠŸè¼‰å…¥å¾Œï¼ŒåŸ·è¡ŒæŒ‰éˆ•æ¸²æŸ“
            script.onload = function() {
                try {
                    paypal.Buttons({
                        // --- é€™æ˜¯æˆ‘å€‘ä¿®æ”¹éçš„éƒ¨åˆ†ï¼Œç¾åœ¨èƒ½é¡¯ç¤ºè©³ç´°éŒ¯èª¤ ---
                        createOrder: function(data, actions) {
                            return fetch('/create-paypal-order', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ articlePath, price, currency })
                            })
                            .then(res => {
                                if (!res.ok) {
                                    // å¦‚æœå¾Œç«¯è¿”å›éŒ¯èª¤ï¼Œè®€å–éŒ¯èª¤è¨Šæ¯ä¸¦æ‹‹å‡º
                                    return res.json().then(errData => { throw errData; });
                                }
                                return res.json();
                            })
                            .then(orderData => {
                                // æˆåŠŸï¼Œè¿”å›è¨‚å–® ID
                                return orderData.id;
                            })
                            .catch(err => {
                                // ç”¨ alert é¡¯ç¤ºå¾å¾Œç«¯å‚³ä¾†çš„è©³ç´°éŒ¯èª¤ï¼
                                alert('å‰µå»ºè¨‚å–®å¤±æ•—ï¼\n\nå¾Œç«¯èªªï¼š\n' + JSON.stringify(err, null, 2));
                                // è®“ PayPal çš„å½ˆçª—é—œé–‰
                                return actions.reject();
                            });
                        },
                        
                        // onApprove ä¿æŒä¸è®Š
                        onApprove: function(data, actions) {
                            return fetch('/capture-paypal-order', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ orderID: data.orderID, articlePath })
                            })
                            .then(res => res.ok ? res.text() : Promise.reject('è§£é–å¤±æ•—'))
                            .then(htmlContent => {
                                gateway.innerHTML = htmlContent;
                            }).catch(err => {
                                alert(err.toString() + ' è¨‚å–®è™Ÿï¼š' + data.orderID);
                            });
                        },
                        
                        // onError ä¿æŒä¸è®Š
                        onError: function(err) {
                            alert('PayPal æŒ‰éˆ•ç™¼ç”Ÿ onError éŒ¯èª¤ï¼š' + err.toString());
                        }
                    }).render('#paypal-button-container');
                } catch (err) {
                    alert('åœ¨ script.onload ä¸­ç™¼ç”Ÿäº† try-catch éŒ¯èª¤ï¼š' + err.toString());
                }
            };

            // d. onerror å›èª¿ (ä¿æŒä¸è®Š)
            script.onerror = function() {
                alert('è‡´å‘½éŒ¯èª¤ï¼šå¾å¾Œç«¯ä»£ç†è¼‰å…¥ SDK å¤±æ•—ï¼');
            };

            // e. æ’å…¥ script æ¨™ç±¤
            document.head.appendChild(script);

        })();
    </script>

{{ else if .Params.secure }}
    {{/* --- é¸é …äºŒï¼šå¾Œç«¯å¯†ç¢¼é–ç‰† (æœ¬èº«æ˜¯å®‰å…¨çš„) --- */}}
    <div id="secure-content-placeholder" class="py-3 my-2" data-path="{{ .RelPermalink }}">
         {{/* å¯†ç¢¼æ¡†çš„ HTML ... */}}
    </div>
    {{/* JS åœ¨ baseof.html */}}

{{ else if .Params.password }}
    {{/* --- é¸é …ä¸‰ï¼šå‰ç«¯å¯†ç¢¼é–ç‰† (æœ‰åŒæ¨£çš„å®‰å…¨é¢¨éšªï¼) --- */}}
    <div id="encryption-container" class="py-3 my-2">
        {{/* å¯†ç¢¼æ¡†çš„ HTML ... */}}
    </div>
    <div style="display:none;">{{ .Content }}</div> {{/* è­¦å‘Šï¼šé€™è£¡çš„å…§å®¹åœ¨åŸå§‹ç¢¼ä¸­å¯è¦‹ï¼ */}}
    {{/* JS åœ¨æ­¤è™• */}}

{{ end }}

{{/* ================================================================== */}}
{{/*                       è¤‡è£½åˆ°é€™è£¡çµæŸ                       */}}
{{/* ================================================================== */}}
      
      {{ if or (and site.Params.social.share (eq site.Params.position.social.share "bottom")) (and site.Params.position.postMeta $postMetaBottom) (and (site.Params.position.postMeta.tags.content) (eq site.Params.position.postMeta.tags.content "bottom")) }}
        <div class="pt-4 mt-2 border-top">
          <div class="row">
            {{- if and site.Params.position.postMeta $postMetaBottom }}
            <div class="col-md-7 small text-muted post-meta my-1">
            
              {{- $wordCount := "" }}
              {{- $readingTime := "" }}
              {{- $author := "" }}
              {{- $lastUpdated := "" }}
              
              {{- if and site.Params.position.postMeta.wordCount.content (eq site.Params.position.postMeta.wordCount.content "bottom") }}
                {{- $wordCount = print (.WordCount) " words" }}
              {{- end }}
              {{- if and site.Params.position.postMeta.readingTime.content (eq site.Params.position.postMeta.readingTime.content "bottom") }}
                {{- $readingTime = print (lang.NumFmt 0 (div .WordCount 130)) " min read" -}}
              {{- end }}
              {{- if and site.Params.position.postMeta.author.content (eq site.Params.position.postMeta.author.content "bottom") }}
                {{- $author = print "By " (default site.Params.meta.author .Params.author) }}
              {{- end }}
              {{- if .Lastmod }}
                {{- if and site.Params.position.postMeta.lastUpdated.content (eq site.Params.position.postMeta.lastUpdated.content "bottom") }}
                  {{- $lastUpdated = print "<span class=''>Last updated: " (.Lastmod.Format "January 2, 2006") }}</span>
                {{- end }}
              {{- end }}
              
              {{- $postMetaPre := slice $author $wordCount $readingTime $lastUpdated }}
              {{ $postMeta := slice }}
              {{ range $postMetaPre }}
                {{ if . }}
                  {{ $postMeta = $postMeta | append . }}
                {{ end }}
              {{ end }}
              
              {{- delimit $postMeta " &#183; " -}}
            
            </div>
            {{ end }}
            
            {{ if and site.Params.social.share (eq site.Params.position.social.share "bottom") }}
            <div class="col-md-auto ml-3 my-1">
              <div class="row">
                <div class="col-auto p-0">
                Share on:&nbsp;&nbsp;
                </div>
                <div class="col p-0">
                  <span class="lead">
                    {{ if in site.Params.social.share "facebook" }}
                      <a href="https://www.facebook.com/sharer/sharer.php?u={{ .Permalink }}&quote={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Facebook" aria-label="Share on Facebook"><span class="fab fa-facebook"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "twitter" }}
                      <a href="https://twitter.com/intent/tweet?source={{ .Permalink }}&text={{ .Title }}:%0A{{ .Permalink }}" rel="noreferrer nofollow" target="_blank" title="Share on Twitter" aria-label="Share on Twitter"><span class="fab fa-twitter"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "linkedin" }}
                      <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ .Permalink }}&title={{ .Title }}&summary={{ .Params.description }}&source={{ site.Title }}" rel="noreferrer nofollow" target="_blank" title="Share on LinkedIn" aria-label="Share on LinkedIn"><span class="fab fa-linkedin"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "telegram" }}
                      <a href="https://t.me/share/url?url={{ .Permalink }}&text={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Telegram" aria-label="Share on Telegram"><span class="fab fa-telegram"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "whatsapp" }}
                      <a href="whatsapp://send?text={{ .Permalink }}%0A%0A{{ .Title }}" data-text="{{ .Title }}" data-href="{{ .Permalink }}" rel="noreferrer nofollow" target="_blank" title="Share on Whatsapp" aria-label="Share on Whatsapp"><span class="fab fa-whatsapp"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "reddit" }}
                      <a href="https://reddit.com/submit?url={{ .Permalink }}&title={{ .Title }}" rel="noreferrer nofollow" target="_blank" title="Share on Reddit" aria-label="Share on Reddit"><span class="fab fa-reddit"></span></a>&nbsp;&nbsp;
                    {{ end }}
                    {{ if in site.Params.social.share "email" }}
                      <a href="mailto:?subject={{ .Title }}&body={{ .Params.description }}%0A%0A{{ .Permalink }}" target="_blank" title="Share via email" aria-label="Share via email"><span class="fas fa-envelope"></span></a>
                    {{ end }}
                  </span>
                </div>
              </div>
            </div>
            {{ end }}
          </div>
        
          {{ if and (site.Params.position.postMeta.tags.content) (ne site.Params.position.postMeta.tags.content "top") }}
            <div class="mt-3">
              {{- range .Params.tags -}}
                <a href="/tags/{{ . | urlize }}/"><span class="badge badge-pill bg-clr2 text-nav mr-2 py-2">#{{ . | humanize | upper }}</span></a>
              {{- end -}}
            </div>
          {{ end }}
        
        </div>
      {{ end }}
    </div>
  </div>
  
  {{ if site.DisqusShortname }}
    <div class="my-5">
      {{ if eq hugo.Environment "production" -}}
        {{ template "_internal/disqus.html" . }}
      {{ else }}
        <p class="lead text-center">This is where Disqus comments would appear on production website.</p>
      {{ end }}
    </div>
  {{ end }}
  
</div>
{{ end }}
